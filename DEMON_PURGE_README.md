# 除魔任务自动化功能

## 功能概述

除魔任务自动化功能是《百战沙场》游戏自动化脚本的新增功能，能够自动完成除魔任务的完整流程，包括：

- ✅ 自动查找和识别除魔任务
- ✅ 自动接取除魔任务
- ✅ 自动执行任务（前往完成）
- ✅ 自动监测任务完成状态
- ✅ 自动领取任务奖励
- ✅ 支持多次循环执行
- ✅ 智能错误处理和重试机制

## 技术实现

### 核心组件

1. **DemonPurgeTask.ahk** - 除魔任务主控制器
2. **DemonPurgeTemplates.ahk** - 图像模板管理器
3. **DemonPurgeTest.ahk** - 测试和调试工具

### 关键技术

- **图像识别**：使用模板匹配和颜色识别双重验证
- **鼠标自动化**：精确的鼠标移动和点击控制
- **状态监测**：实时监测任务状态变化
- **安全防护**：多重安全检查和异常处理

## 使用方法

### 1. 启用除魔任务

在配置文件 `resources/config/config.ini` 中：

```ini
[tasks]
enable_demon_purge=true

[demon_purge]
max_daily_cycles=10
cycle_delay=2000
```

### 2. 运行测试

启动脚本后，按 `F10` 启动自动化，或在控制台运行：

```ahk
RunDemonPurgeTests()
```

### 3. 正常使用

除魔任务会自动集成到主任务调度系统中，按照设定的间隔自动执行。

## 配置参数

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `max_daily_cycles` | 10 | 每日最大执行次数 |
| `cycle_delay` | 2000 | 执行间隔（毫秒） |
| `taskbar_area` | 100\|200\|300\|600 | 任务栏滚动区域 |
| `task_completion_timeout` | 30000 | 任务完成超时时间 |
| `retry_attempts` | 3 | 重试次数 |

## 界面元素识别

### 任务栏区域
- **位置**：右侧任务栏（红框内）
- **识别方式**：文字模板匹配 + 颜色特征识别
- **拖动方式**：模拟鼠标上下滚动查找任务

### 状态识别
- **可接状态**：绿色文字识别
- **完成状态**：灰色文字识别
- **双重验证**：模板匹配 + 颜色统计

### 按钮识别
- **鞋子图标**：模板匹配优先，回退到坐标点击
- **接受任务**：模板匹配 + 区域中心点击
- **前往完成**：模板匹配 + 区域中心点击
- **领取奖励**：模板匹配 + 区域中心点击

## 安全特性

### 异常处理
- 游戏窗口未激活自动重试
- 错误对话框自动关闭
- 网络异常自动重连

### 防检测机制
- 随机延迟避免机械操作
- 人性化鼠标移动轨迹
- 异常情况随机暂停

### 资源保护
- 内存泄漏自动清理
- CPU使用率限制
- 磁盘空间监控

## 测试和调试

### 运行测试
```ahk
test := DemonPurgeTest()
test.RunAllTests()
```

### 调试信息
- 日志级别：INFO（生产环境）/ DEBUG（调试环境）
- 截图保存：异常时自动保存游戏窗口截图
- 状态监控：实时显示任务执行状态

### 常见问题

1. **任务未找到**
   - 检查游戏窗口是否正常显示
   - 确认任务栏区域配置正确
   - 查看模板文件是否存在

2. **点击不准确**
   - 检查游戏分辨率设置
   - 确认窗口位置和大小
   - 调整点击区域配置

3. **状态识别错误**
   - 检查颜色阈值配置
   - 确认文字显示正常
   - 调整识别灵敏度

## 性能优化

- **图像识别**：模板缓存 + 区域限制
- **内存管理**：及时释放位图资源
- **执行效率**：异步处理 + 智能等待

## 更新日志

### v1.0.0
- ✅ 实现基本除魔任务自动化
- ✅ 添加图像模板管理
- ✅ 集成任务调度系统
- ✅ 添加测试和调试工具